name: Create Release

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°(v1.0.0, v1.1.0ãªã©)ãŒpushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # ã‚¿ã‚°åã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆv1.0.0 -> 1.0.0ï¼‰
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # manifest.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
      - name: Verify version matches manifest.json
        run: |
          MANIFEST_VERSION=$(grep '"version"' manifest.json | sed 's/.*"version": "\(.*\)".*/\1/')
          if [ "$MANIFEST_VERSION" != "${{ steps.get_version.outputs.VERSION }}" ]; then
            echo "âŒ Error: Tag version (${{ steps.get_version.outputs.VERSION }}) does not match manifest.json version ($MANIFEST_VERSION)"
            exit 1
          fi
          echo "âœ… Version verified: $MANIFEST_VERSION"

      # Chrome Web Storeç”¨ã®zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      - name: Create release zip
        run: |
          ZIP_NAME="portal_backimg_v${{ steps.get_version.outputs.VERSION }}.zip"
          echo "ğŸ“¦ Creating $ZIP_NAME..."
          
          zip -r "$ZIP_NAME" \
            manifest.json \
            service_worker.js \
            content_scripts/content_scripts.js \
            popup/popup.html \
            popup/css/popup.css \
            popup/js/script.js \
            img/ \
            -x "*.ts" "*/tsconfig.json" "*/.git/*" "*/node_modules/*" "*.zip" "*.sh" "*.py"
          
          echo "âœ… Created $ZIP_NAME"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # zipãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - name: List zip contents
        run: |
          echo "ğŸ“‹ Zip contents:"
          unzip -l "${{ env.ZIP_NAME }}"

      # GitHub Releaseã‚’ä½œæˆã—ã¦zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
          body: |
            ## ğŸ‰ Version ${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸ“¦ Chrome Web Storeç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            - `${{ env.ZIP_NAME }}` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Chrome Web Storeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
            
            ### ğŸ“ å¤‰æ›´å†…å®¹
            ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ã“ã“ã«è¨˜è¼‰ã—ã¦ãã ã•ã„
            
            ### ğŸ”— ãƒªãƒ³ã‚¯
            - [Chrome Web Store](https://chromewebstore.google.com/detail/background-image-config-f/your-extension-id)
            - [GitHub Repository](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æˆåŠŸé€šçŸ¥
      - name: Success notification
        run: |
          echo "âœ¨ Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo "ğŸ“¦ Zip file: ${{ env.ZIP_NAME }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }}"
